name: Manual Symfony Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          coverage: none
          tools: composer:v2
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, gd, iconv, json, mbstring, pdo
        env:
          update: true

      - name: Check PHP Version
        run: php -v

      - name: Copy .env.prod
        run: cp .env.prod .env

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Clear Symfony Cache for prod
        run: php bin/console cache:clear

      - name: Make production envfile
        uses: SpicyPizza/create-envfile@v1
        with:
          envkey_APP_ENV: prod
          envkey_APP_DEBUG: false
          envkey_APP_SECRET: ${{ secrets.APP_SECRET }}
          file_name: .env

      - name: Copying files to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}  # Use your SSH password here
          port: ${{ secrets.SSH_PORT }}  # Optional, specify your SSH port
          source: "./"
          target: "/"

      - name: Executing remote ssh commands
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}  # Use your SSH password here
          port: ${{ secrets.SSH_PORT }}  # Optional, specify your SSH port
          script: |
            git pull origin master
            composer install --no-dev --optimize-autoloader
            APP_ENV=prod php bin/console cache:clear
            npm run build
            # Add any additional Symfony-specific commands or setup here
